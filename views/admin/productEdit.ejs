<meta charset="UTF-8">
<head>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.css"/>
    <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>
</head>
<body>
<div class="container">
    <div id="content">
        <div id="result" style="display: none;"><%= JSON.stringify(product) %></div>
        <div style="margin: 3% auto; font-size: 20px; text-align: center;">상품수정</div>
        <table class="table table-hover">
            <tr><th>상품코드</th><td><p id="product_code"><%= product.code %></p></td></tr>
            <tr><th>카테고리</th><td><select id="product_category" class="form-select" aria-label="Default select example">
                        <option selected>카테고리</option>
                        <option value="화장품">화장품</option>
                        <option value="식품">식품</option>
                        <option value="건강">건강</option>
                        <option value="리빙">리빙</option>
                        <option value="패션잡화">패션잡화</option>
                        <option value="디지털">디지털</option>
                    </select></td></tr>
            <tr><th>브랜드</th><td><input id="product_brand" type="text" class="form-control"aria-describedby="basic-addon1" value="<%= product.brand %>"></td></tr>
            <tr><th>썸네일</th><td><input id="product_thumbnail" type="text" class="form-control"aria-describedby="basic-addon1" value="<%= product.thumbnail %>"></td></tr>
            <tr><th>이미지</th><td>
                    <textarea id="product_images" class="form-control" rows="5" placeholder="쉼표(,)로 구분해주세요"></textarea>
                </td></tr>
            <tr><th>제품링크</th><td><input id="product_link" type="text" class="form-control"aria-describedby="basic-addon1" value="<%= product.link %>"></td></tr>
            <tr><th>상품명</th><td><input id="product_name" type="text" class="form-control"aria-describedby="basic-addon1" value="<%= product.name %>"></td></tr>
            <tr><th>상품소개</th><td><input id="product_description" type="text" class="form-control"aria-describedby="basic-addon1" value="<%= product.description %>"></td></tr>
            <tr><th>상품정보<br>제공고시</th><td>
                    <textarea id="product_detail" class="form-control" rows="7">
                    </textarea>
                </td>
            </tr>
            <tr><th>소비자가격</th><td><input id="product_retail_price" type="text" class="form-control"aria-describedby="basic-addon1" value="<%= product.retailPrice %>"></td></tr>
            <tr><th>마진율</th><td><input id="product_fee_rate" type="text" class="form-control"aria-describedby="basic-addon1" value="<%= product.feeRate %>"></td></tr>
            <tr><th>노출수</th><td><%= product.viewCount %></td></tr>
            <tr><th>좋아요수</th><td><%= product.likeCount %></td></tr>
            <tr><th>주문수</th><td><%= product.orderCount %></td></tr>
            <tr><th>성별</th><td><div class="input-group mb-3  register">
                        <select id="product_gender" class="form-select multiple">
                            <option value="전체">전체</option>
                            <option value="남성">남성</option>
                            <option value="여성">여성</option>
                        </select>
                    </div></td></tr>
            <tr><th>연령대</th><td>
                    <div class="input-group mb-3 register">
                        <select id="product_age" class="form-select">
                            <option value="연령대">연령대</option>
                            <option value="20~24세">20~24세</option>
                            <option value="25~29세">25~29세</option>
                            <option value="30~34세">30~34세</option>
                            <option value="35~39세">35~39세</option>
                            <option value="40~44세">40~44세</option>
                            <option value="45세 이상">45세 이상</option>
                        </select>
                    </div>
                </td></tr>
            <tr><th>가격대</th><td>
                    <select id="product_price" class="form-select" aria-label="Default select example">
                        <option value="가격대">가격대</option>
                        <option value="1만 5천원">1만 5천원</option>
                        <option value="2만원">2만원</option>
                        <option value="2만 5천원">2만 5천원</option>
                        <option value="3만원">3만원</option>
                        <option value="3만 5천원">3만 5천원</option>
                        <option value="4만원">4만원</option>
                        <option value="4만 5천원">4만 5천원</option>
                        <option value="5만원">5만원</option>
                    </select>
                </td></tr>
        </table>
        <button id="register" style="margin: 5% 40%;" type="button" class="btn btn-primary">저장</button>
    </div>
</div>
<script>
    (function($) {
        $(function() {
            $('#register').click(save);
        });

        let product = JSON.parse($('#result').text());
        console.log(product);
        $('#product_category').val(product.category).prop("selected",true)
        $("#product_detail").val(product.detail.replace(/<br>/gi,'\n'));
        $('#product_images').val(product.images.join("\n"));

        $('#product_gender').val(product.gender).prop("selected",true)
        $('#product_age').val(product.age).prop("selected",true)
        $('#product_price').val(product.price).prop("selected",true)

        async function save() {
            if ($('#product_category').val() === "카테고리") {
                alert("카테고리를 입력해주세요.");
            } else if ($('#product_name').val() === "") {
                alert("상품명을 입력해주세요.");
            } else if ($('#product_brand').val() === "") {
                alert("판매처를 입력해주세요.");
            } else if ($('#product_retail_price').val() === "") {
                alert("소비자가를 입력해주세요.");
            } else if ($('#product_fee_rate').val() === "") {
                alert("수수로율을 입력해주세요.");
            } else if ($('#product_link').val() === "") {
                alert("링크를 입력해주세요.");
            } else if ($('#product_age').val() === "연령대") {
                alert("연령대를 선택해주세요.");
            } else if ($('#product_price').val() === "가격대") {
                alert("가격대를 선택해주세요.");
            }

            const detail =$('#product_detail').val().replace(/\n/gi, '<br>');

            // TODO: script로 refactoring하기. => 수정시에도 thumbnail과 images가 보존되도록 하는 작업 필요
            const formData = new FormData();
            formData.append('category', $('#product_category').val());
            formData.append('code', $('#product_code').text());
            formData.append('name', $('#product_name').val());
            formData.append('thumbnail', $('#product_thumbnail').val());
            formData.append('images', $('#product_images').val());
            formData.append('brand', $('#product_brand').val());
            formData.append('retail_price', $('#product_retail_price').val());
            formData.append('fee_rate', $('#product_fee_rate').val());
            formData.append('link', $('#product_link').val());
            formData.append('description', $('#product_description').val());
            formData.append('detail', detail);
            formData.append('gender', $('#product_gender').val());
            formData.append('age', $('#product_age').val());
            formData.append('price', $('#product_price').val());

            // for (let value of formData.values()) {
            //     console.log(value);
            // }
            try {
                await axios.post('http://localhost:4242/admin/product/edit', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data; charset=utf-8'
                    }
                });
                alert("수정된 상품 정보가 저장되었습니다.");
            } catch (err) {
                console.log("form data 전송 실패", err);
            }
        }
    })(jQuery);

</script>
</body>
</html>
