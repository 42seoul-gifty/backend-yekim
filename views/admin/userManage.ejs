<meta charset="UTF-8">
<head>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>-->
<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.min.js"></script>-->
<!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.css"/>-->
    <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-3">
            <%- include ('nav') -%>
        </div>
        <div class="col-9">
            <div id="content">
                <table id="select" style="float: right; padding-bottom: 10px;">
                    <tr>
                        <td>
                            <div style="margin-left: 30px;" id="pagination"></div>
                        </td>
                    </tr>
                </table>
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th scope="col">No</th>
                        <th scope="col">회원명</th>
                        <th scope="col">가입일<i class="fas fa-sort" id="join_date"></i></th>
                        <th scope="col">구매횟수<i class="fas fa-sort" id="purchase_count"></i></th>
                        <th scope="col">구매금액<i class="fas fa-sort" id="purchase_amount"></i></th>
                        <th scope="col"></th>
                        <th scope="col"></th>
                    </tr>
                    </thead>
                    <tbody id="user_list">

                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
    (function ($) {
        $(async function() {
            const sortFlags = { purchaseCount: 0 };
            function showUsers() {
                $('#user_list').empty();
                $.each(users, function (index, item) {
                    const tmpUserRow = makeUserRow(item);
                    $('#user_list').append(tmpUserRow);
                })
            }

            let users = await getUserDataFromServer();
            users = setUsersInformation(users.data);
            showUsers(users);

            $("#join_date").click(function() {
                console.log("join_date pushed");
                // $.each(users, function (index, item) {
                //     const tmpUserRow = makeUserRow(item);
                //     $('#user_list').append(tmpUserRow);
                // })
            });
            $("#purchase_count").click(async function() {
                ++sortFlags.purchaseCount;
                const sign = sortFlags.purchaseCount % 2 ? 1 : -1;
                users = users.sort(function(user1, user2) {
                    return sign * (user1.purchaseCount - user2.purchaseCount);
                });
                $('#user_list').empty();
                showUsers(users);
            });
        });
    })(jQuery);

    function setUsersInformation(users) {
        users.forEach((user) => {
            const joinDate = user.createdAt.split('T')[0].replace(/-/g,'.');
            const orders = user.Order;
            let totalPurchaseAmount = 0;
            orders.forEach((order) => {
                totalPurchaseAmount += order.purchaseAmount;
            });

            user.joinDate = joinDate;
            user.purchaseCount = orders.length;
            user.totalPurchaseAmount = totalPurchaseAmount;
        }, users)
        return (users);
    }

    async function getUserDataFromServer() {
        try {
            const ret = await axios.get('/admin/user/manage', {
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            return ret;
        } catch (err) {
            console.log("유저 데이터 조회 오류:", err);
            return undefined;
        }
    }

    function makeUserRow(user) {
        let userRow = '<tr>';
        userRow += `<td scope="col"><p>${user.id}</p></td>`;
        userRow += `<td scope="col"><p>${user.name}</p></td>`;
        userRow += `<td scope="col"><p>${user.joinDate}</p></td>`;
        userRow += `<td scope="col"><p>${user.purchaseCount}</p></td>`;
        userRow += `<td scope="col"><p>${user.totalPurchaseAmount}</p></td>`;
        userRow += `<td scope="col"><button type="button" class="btn btn-light"><p>삭제</button></p></td>`;
        userRow += '</tr>'
        return userRow;
    }

    function sortUsers(users) {

    }



    // (function($) {
    //     $(function() {
    //
    //         if(sessionStorage.getItem('login')!=='true'){
    //             alert("로그인이 필요한 서비스입니다.")
    //             location.href="https://gifty4u.com/admin"
    //         }
    //         let container = $('#pagination');
    //         container.pagination({
    //             pageSize: 10,
    //             dataSource:  function(done){
    //                 fetch(`https://gifty4u.com/admin/user/sort?value=join_date&sort=desc`, {
    //                     method: "GET",
    //                     headers: {
    //                         "Content-Type": "application/json",
    //                     },
    //                 }).then((response) => response.json())
    //                     .then((res)=>{
    //                         console.log(res)
    //                         done(res.data)
    //                     })
    //                     .catch((err)=>{
    //                         console.log(err)
    //                     })
    //             },
    //             callback: function (data, pagination) {
    //                 $('#user_list').empty();
    //                 console.log(data);
    //                 var dataHtml= '';
    //                 $.each(data, function (index, user) {
    //                     if(user.comment == null){
    //                         user.comment = "없음";
    //                     }
    //                     dataHtml += `<tr> <td scope="col"><p>${index+1}</p></td>
    //                   <td scope="col"><p>${user.nickname}</p></td>
    //                   <td scope="col"><p>${user.join_date}</p></td>
    //                   <td scope="col"><p>${user.purchase_no}</p></td>
    //                   <td scope="col"><p>${user.purchase_amount}</p></td>
    //                   <td scope="col"><button type="button" class="btn btn-light" onclick="deleteUser('${user.user_id}')">탈퇴처리</button></td></tr>`
    //                 });
    //                 $("#user_list").append(dataHtml);
    //             }
    //         })
    //     });
    //
    // })(jQuery);
    //
    // function userSort(value){
    //     let container = $('#pagination');
    //     container.pagination({
    //         pageSize: 10,
    //         dataSource:  function(done){
    //             fetch(`https://gifty4u.com/admin/user/sort?value=${value}&sort=desc`, {
    //                 method: "GET",
    //                 headers: {
    //                     "Content-Type": "application/json",
    //                 },
    //             }).then((response) => response.json())
    //                 .then((res)=>{
    //                     console.log(res.data)
    //                     done(res.data)
    //                 })
    //                 .catch((err)=>{
    //                     console.log(err)
    //                 })
    //         },
    //         callback: function (data, pagination) {
    //             $('#user_list').empty();
    //             console.log(data);
    //             var dataHtml= '';
    //             $.each(data, function (index, user) {
    //                 if(user.comment == null){
    //                     user.comment = "없음";
    //                 }
    //                 dataHtml += `<tr> <td scope="col"><p>${index}</p></td>
    //                   <td scope="col"><p>${user.nickname}</p></td>
    //                   <td scope="col"><p>${user.join_date}</p></td>
    //                   <td scope="col"><p>${user.purchase_no}</p></td>
    //                   <td scope="col"><p>${user.purchase_amount}</p></td>
    //                   <td scope="col"><p>${user.comment}</p></td></tr>`
    //             });
    //             $("#user_list").append(dataHtml);
    //         }
    //     })
    // }
    //
    // function deleteUser(user_id){
    //     fetch("https://gifty4u.com/admin/user", {
    //         method: "DELETE",
    //         headers: {
    //             "Content-Type": "application/json",
    //         },
    //         body: JSON.stringify({
    //             user_id:user_id,
    //         }),
    //     }).then((response) => response.json())
    //         .then((res)=>{
    //             console.log(res.data)
    //             if(res.data==='delete'){
    //                 alert("회원이 삭제됐습니다.")
    //                 window.location.reload();
    //             }
    //         }).catch((err)=>{
    //         alert(err.error)
    //         console.log(err.error)
    //     })
    //
    // }
</script>
</body>
</html>
